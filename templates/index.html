<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>éº»å°†å†³ç­–è¾…åŠ©ç»ˆç«¯ v1.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* åŸºç¡€å­—ä½“æ ·å¼ä¼˜åŒ– */
        .mahjong-tile { font-family: "Segoe UI Emoji", "Noto Color Emoji", "Apple Color Emoji", sans-serif; font-size: 3.2rem; line-height: 1; text-shadow: 1px 1px 2px rgba(0,0,0,0.15); cursor: pointer; user-select: none; transition: transform 0.1s, background-color 0.1s; }
        .mahjong-tile:hover { transform: translateY(-3px); }
        .mahjong-tile:active { transform: translateY(0); }
        .mahjong-tile-small { font-family: "Segoe UI Emoji", "Noto Color Emoji", sans-serif; font-size: 2rem; line-height: 1; }

        /* ã€æ–°å¢ã€‘ï¼šéº»å°†ç‰Œè‰²æŒ‡å®š */
        .tile-man { color: #D32F2F; } /* ä¸‡å­ï¼šæ·±çº¢ */
        .tile-pin { color: #1976D2; } /* ç­’å­ï¼šæ·±è“ */
        .tile-sou { color: #388E3C; } /* ç´¢å­ï¼šæ·±ç»¿ */
        .tile-zi { color: #424242; }  /* å­—ç‰Œï¼šæ·±ç° */

        .tile-btn { @apply bg-white border-2 border-gray-200 rounded-lg shadow-sm flex items-center justify-center p-1 h-16 hover:border-blue-400 hover:bg-blue-50; }
        .hand-tile { @apply bg-white border-b-4 border-gray-300 rounded-t shadow-md px-1 pb-1 mx-[2px]; }

        /* Checkbox å¼€å…³åŠ¨ç”» */
        input:checked ~ .dot { transform: translateX(100%); background-color: #60A5FA; }
        input:not(:checked) ~ .dot { transform: translateX(0); background-color: #9CA3AF; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans pb-20">

<div class="container mx-auto px-4 py-6 max-w-4xl">
    <div class="bg-gray-800 text-white rounded-t-xl p-4 flex justify-between items-center shadow-lg">
        <div>
            <span class="text-sm text-gray-400 block mb-1">å½“å‰é˜¶æ®µ</span>
            <span id="phaseIndicator" class="text-xl font-bold text-yellow-400">ğŸŸ¡ èµ·æ‰‹é…ç‰Œ</span>
        </div>
        <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2 border-r border-gray-600 pr-4">
                <label class="text-xs text-gray-400">åœºé£</label>
                <select id="roundWind" class="bg-gray-700 text-white rounded text-sm outline-none px-1 py-0.5 cursor-pointer" onchange="requestAnalysis()">
                    <option value="27" selected>ä¸œ</option>
                    <option value="28">å—</option>
                    <option value="29">è¥¿</option>
                    <option value="30">åŒ—</option>
                </select>
                <label class="text-xs text-gray-400 ml-2">è‡ªé£</label>
                <select id="playerWind" class="bg-gray-700 text-white rounded text-sm outline-none px-1 py-0.5 cursor-pointer" onchange="requestAnalysis()">
                    <option value="27">ä¸œ</option>
                    <option value="28" selected>å—</option>
                    <option value="29">è¥¿</option>
                    <option value="30">åŒ—</option>
                </select>
            </div>

            <label class="flex items-center cursor-pointer" title="å…³é—­åå°†ä¸éªŒè¯å½¹ç§ï¼Œå¼ºè¡Œç»™åˆ†">
                <div class="relative">
                    <input type="checkbox" id="requireYaku" class="sr-only" checked onchange="requestAnalysis()">
                    <div class="block bg-gray-600 w-10 h-6 rounded-full"></div>
                    <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition transform bg-blue-400"></div>
                </div>
                <div class="ml-2 text-sm font-bold text-gray-300">æ— å½¹ä¸èƒ½å’Œ</div>
            </label>

            <button onclick="resetGame()" class="bg-red-500 hover:bg-red-600 px-3 py-1.5 rounded font-bold text-sm transition ml-2">â†» é‡ç½®</button>

            <button onclick="window.location.href='/match'" class="bg-purple-600 hover:bg-purple-500 px-4 py-1.5 rounded font-bold text-sm transition ml-4 shadow-[0_0_10px_rgba(147,51,234,0.5)] border border-purple-400 flex items-center">
                âš”ï¸ è¿›å…¥å¯¹æˆ˜æ²™ç›’
            </button>
        </div>
    </div>

    <div class="bg-white p-6 shadow-md rounded-b-xl mb-6">
        <div id="doraContainer" class="hidden mb-4 border-b pb-4 bg-yellow-50 p-2 rounded border border-yellow-200 shadow-inner">
            <h2 class="text-sm font-bold text-yellow-800 mb-2">âœ¨ å®ç‰ŒæŒ‡ç¤ºç‰Œ <span class="text-xs font-normal text-yellow-600">(ç‚¹å‡»å¯å–æ¶ˆ)</span></h2>
            <div id="doraArea" class="flex flex-wrap gap-2 items-end"></div>
        </div>

        <div id="meldContainer" class="hidden mb-4 border-b pb-4 bg-orange-50 p-2 rounded">
            <h2 class="text-sm font-bold text-gray-600 mb-2">æˆ‘çš„å‰¯éœ² (åƒ/ç¢°/æ ) <span class="text-xs font-normal text-gray-400">ç‚¹å‡»å¯å–æ¶ˆ</span></h2>
            <div id="meldArea" class="flex flex-wrap gap-3 items-end"></div>
        </div>

        <div class="mb-6 border-b pb-4">
            <div class="flex justify-between items-end mb-2">
                <h2 class="text-lg font-bold text-gray-700">æˆ‘çš„æ‰‹ç‰Œ</h2>
                <span id="shantenBadge" class="hidden text-xs font-bold px-2 py-1 rounded"></span>
            </div>
            <div id="handArea" class="flex flex-wrap min-h-[5rem] bg-green-100/50 p-3 rounded-xl border-2 border-green-200 items-end justify-center shadow-inner"></div>
            <p id="handHint" class="text-xs text-gray-400 mt-2 text-center">ç‚¹å‡»ä¸‹æ–¹ç‰Œåº“é€‰æ‹©èµ·æ‰‹ç‰Œ...</p>
        </div>

        <div id="resultArea" class="hidden mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <h3 class="font-bold text-blue-800 mb-3 flex items-center">âœ¨ AI å†³ç­–å»ºè®® <span class="text-xs font-normal text-blue-600 ml-2 animate-pulse">(ç‚¹å‡»ä¸‹æ–¹é€‰é¡¹å¯ç›´æ¥æ‰“å‡º)</span></h3>
            <div id="recommendationsList" class="space-y-3"></div>
        </div>
    </div>

    <div class="bg-white p-6 shadow-md rounded-xl">
        <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-2">
            <h2 class="text-lg font-bold text-gray-700">äº¤äº’é”®ç›˜</h2>
            <div class="flex flex-wrap bg-gray-200 rounded-lg p-1 gap-1 shadow-inner">
                <button id="modeSelf" onclick="setKeyboardMode('self')" class="px-4 py-1 rounded-md bg-white shadow text-sm font-bold text-blue-600 transition">ğŸ“¥ æ‘¸ç‰Œ</button>
                <button id="modeOpponent" onclick="setKeyboardMode('opponent')" class="px-4 py-1 rounded-md text-sm font-bold text-gray-500 hover:text-gray-700 transition">ğŸ‘ï¸ æ­»ç‰Œ</button>
                <button id="modeDora" onclick="setKeyboardMode('dora')" class="px-4 py-1 rounded-md text-sm font-bold text-gray-500 hover:text-yellow-600 transition">âœ¨ å®ç‰Œ</button>
                <button id="modeKan" onclick="setKeyboardMode('kan')" class="px-4 py-1 rounded-md text-sm font-bold text-gray-500 hover:text-gray-700 transition">ğŸ€„ æ ç‰Œ</button>
                <button id="modePon" onclick="setKeyboardMode('pon')" class="px-4 py-1 rounded-md text-sm font-bold text-gray-500 hover:text-gray-700 transition">ğŸ”— ç¢°ç‰Œ</button>
            </div>
        </div>
        <div id="paletteArea" class="grid grid-cols-9 gap-1.5"></div>
        <div class="mt-4 pt-4 border-t">
            <h3 class="text-sm font-bold text-gray-600 mb-2">åœºä¸Šå·²è®°å½•çš„æ­»ç‰Œ: <span id="deadCount" class="text-gray-400 font-normal">0å¼ </span></h3>
            <div id="deadArea" class="flex flex-wrap gap-x-0.5 gap-y-1 text-2xl opacity-80"></div>
        </div>
    </div>
</div>

<script>
    let state = { hand: [], dead: [], melds: [], dora: [], phase: 'INIT', keyboardMode: 'self' };

    const UNICODE_TILES = [
        "ğŸ€‡\uFE0E","ğŸ€ˆ\uFE0E","ğŸ€‰\uFE0E","ğŸ€Š\uFE0E","ğŸ€‹\uFE0E","ğŸ€Œ\uFE0E","ğŸ€\uFE0E","ğŸ€\uFE0E","ğŸ€\uFE0E", // ä¸‡å­
        "ğŸ€™\uFE0E","ğŸ€š\uFE0E","ğŸ€›\uFE0E","ğŸ€œ\uFE0E","ğŸ€\uFE0E","ğŸ€\uFE0E","ğŸ€Ÿ\uFE0E","ğŸ€ \uFE0E","ğŸ€¡\uFE0E", // ç­’å­
        "ğŸ€\uFE0E","ğŸ€‘\uFE0E","ğŸ€’\uFE0E","ğŸ€“\uFE0E","ğŸ€”\uFE0E","ğŸ€•\uFE0E","ğŸ€–\uFE0E","ğŸ€—\uFE0E","ğŸ€˜\uFE0E", // ç´¢å­
        "ğŸ€€\uFE0E","ğŸ€\uFE0E","ğŸ€‚\uFE0E","ğŸ€ƒ\uFE0E", // ä¸œå—è¥¿åŒ—
        "ğŸ€†\uFE0E","ğŸ€…\uFE0E","ğŸ€„\uFE0E" // ç™½å‘ä¸­
    ];

    // ã€æ–°å¢ã€‘ï¼šè·å–ç‰Œ ID å¯¹åº”çš„é¢œè‰² CSS ç±»
    function getTileColorClass(id) {
        if (id >= 0 && id <= 8) return 'tile-man';
        if (id >= 9 && id <= 17) return 'tile-pin';
        if (id >= 18 && id <= 26) return 'tile-sou';
        return 'tile-zi';
    }

    function getTileCount(tileId) {
        let count = state.hand.filter(id => id === tileId).length + state.dead.filter(id => id === tileId).length + state.dora.filter(id => id === tileId).length;
        state.melds.forEach(m => { if (m.tile === tileId) count += (m.type === 'kan' ? 4 : 3); });
        return count;
    }

    function getTargetHandSize() { return 13 - state.melds.length * 3; }

    function renderPalette() {
        const palette = document.getElementById('paletteArea');
        palette.innerHTML = '';
        UNICODE_TILES.forEach((char, id) => {
            const btn = document.createElement('div');
            btn.id = `palette-btn-${id}`;
            // ã€ä¿®æ”¹ã€‘ï¼šåŠ å…¥é¢œè‰²ç±»
            btn.className = `tile-btn mahjong-tile transition-all duration-200 ${getTileColorClass(id)}`;
            btn.innerText = char;
            btn.onclick = () => handlePaletteClick(id);
            palette.appendChild(btn);
        });
    }

    function setKeyboardMode(mode) {
        state.keyboardMode = mode;
        const modes = ['Self', 'Opponent', 'Kan', 'Pon', 'Dora'];
        modes.forEach(m => {
            const btn = document.getElementById('mode' + m);
            if (mode === m.toLowerCase()) {
                btn.className = "px-4 py-1 rounded-md bg-white shadow text-sm font-bold text-blue-600 transition";
                if(mode === 'opponent') btn.classList.replace('text-blue-600', 'text-gray-800');
                if(mode === 'kan' || mode === 'pon') btn.classList.replace('text-blue-600', 'text-orange-600');
                if(mode === 'dora') btn.classList.replace('text-blue-600', 'text-yellow-600');
            } else {
                btn.className = "px-4 py-1 rounded-md text-sm font-bold text-gray-500 hover:text-gray-700 transition";
            }
        });
    }

    function handlePaletteClick(tileId) {
        if (state.keyboardMode === 'dora') {
            if (getTileCount(tileId) >= 4) return alert("æ•°é‡å·²æ»¡4å¼ ");
            if (state.dora.length >= 5) return alert("æœ€å¤š5å¼ å®ç‰ŒæŒ‡ç¤ºç‰Œ");
            state.dora.push(tileId); updateUI(); return;
        }
        if (state.keyboardMode === 'opponent') {
            if (getTileCount(tileId) >= 4) return alert("æ•°é‡å·²æ»¡4å¼ ");
            state.dead.push(tileId); updateUI(); return;
        }
        if (state.keyboardMode === 'kan' || state.keyboardMode === 'pon') {
            const required = state.keyboardMode === 'kan' ? 4 : 3;
            if (getTileCount(tileId) + required > 4) return alert("æ•°é‡ä¸è¶³ä»¥å‰¯éœ²");
            state.melds.push({ type: state.keyboardMode, tile: tileId }); checkPhase(); updateUI(); return;
        }
        if (getTileCount(tileId) >= 4) return alert("æ•°é‡å·²æ»¡4å¼ ");
        const targetSize = getTargetHandSize();
        if (state.phase === 'INIT' && state.hand.length < targetSize) { state.hand.push(tileId); }
        else if (state.phase === 'DRAW' && state.hand.length === targetSize) { state.hand.push(tileId); requestAnalysis(); }
        else if (state.phase === 'DISCARD') { alert("è¯·å…ˆæ‰“å‡ºä¸€å¼ ç‰Œ"); }
        checkPhase(); updateUI();
    }

    function handleHandClick(index) {
        if (state.phase === 'DISCARD' && state.hand.length === getTargetHandSize() + 1) {
            state.dead.push(state.hand.splice(index, 1)[0]);
            document.getElementById('resultArea').classList.add('hidden');
        } else { state.hand.splice(index, 1); }
        checkPhase(); updateUI();
    }

    function checkPhase() {
        const targetSize = getTargetHandSize();
        if (state.hand.length < targetSize) state.phase = 'INIT';
        else if (state.hand.length === targetSize) state.phase = 'DRAW';
        else if (state.hand.length === targetSize + 1) state.phase = 'DISCARD';
    }

    function updateUI() {
        // æ¸²æŸ“æ‰‹ç‰Œ
        const sortedHand = [...state.hand].sort((a, b) => a - b);
        const handArea = document.getElementById('handArea');
        handArea.innerHTML = '';
        sortedHand.forEach(id => {
            const span = document.createElement('span');
            // ã€ä¿®æ”¹ã€‘ï¼šåŠ å…¥é¢œè‰²ç±»
            span.className = `mahjong-tile hand-tile hover:bg-yellow-50 cursor-pointer ${getTileColorClass(id)}`;
            span.innerText = UNICODE_TILES[id];
            span.onclick = () => handleHandClick(state.hand.indexOf(id));
            handArea.appendChild(span);
        });

        // æ¸²æŸ“å‰¯éœ²
        const meldArea = document.getElementById('meldArea');
        meldArea.innerHTML = '';
        document.getElementById('meldContainer').classList.toggle('hidden', state.melds.length === 0);
        state.melds.forEach((m, index) => {
            const group = document.createElement('div');
            group.className = 'flex bg-white border-b-4 border-orange-300 rounded-t p-1 cursor-pointer hover:bg-red-50 shadow-sm mx-1 items-end';
            group.onclick = () => { state.melds.splice(index, 1); checkPhase(); updateUI(); };
            for(let i=0; i < (m.type === 'kan' ? 4 : 3); i++) {
                const span = document.createElement('span');
                // ã€ä¿®æ”¹ã€‘ï¼šåŠ å…¥é¢œè‰²ç±»
                span.className = `mahjong-tile-small mx-[1px] ${getTileColorClass(m.tile)}`;
                span.innerText = UNICODE_TILES[m.tile];
                group.appendChild(span);
            }
            meldArea.appendChild(group);
        });

        // æ¸²æŸ“å®ç‰ŒæŒ‡ç¤ºç‰Œ
        const doraArea = document.getElementById('doraArea');
        doraArea.innerHTML = '';
        document.getElementById('doraContainer').classList.toggle('hidden', state.dora.length === 0);
        state.dora.forEach((id, index) => {
            const span = document.createElement('span');
            // ã€ä¿®æ”¹ã€‘ï¼šåŠ å…¥é¢œè‰²ç±»
            span.className = `mahjong-tile-small hand-tile hover:bg-red-50 cursor-pointer bg-white shadow px-1 rounded border-yellow-300 ${getTileColorClass(id)}`;
            span.innerText = UNICODE_TILES[id];
            span.onclick = () => { state.dora.splice(index, 1); updateUI(); };
            doraArea.appendChild(span);
        });

        // æ¸²æŸ“æ­»ç‰Œ (éœ€è¦é‡å†™æ¸²æŸ“æ–¹å¼ä»¥æ”¯æŒå„è‡ªçš„é¢œè‰²)
        const deadArea = document.getElementById('deadArea');
        deadArea.innerHTML = '';
        state.dead.forEach(id => {
            const span = document.createElement('span');
            // ã€ä¿®æ”¹ã€‘ï¼šåŠ å…¥é¢œè‰²ç±»
            span.className = getTileColorClass(id);
            span.innerText = UNICODE_TILES[id];
            deadArea.appendChild(span);
        });
        document.getElementById('deadCount').innerText = `${state.dead.length}å¼ `;

        // çŠ¶æ€æŒ‡ç¤ºå™¨ä¸é”®ç›˜é˜²å‘† (çœç•¥ï¼Œæ— å˜åŒ–)
        const indicator = document.getElementById('phaseIndicator');
        const hint = document.getElementById('handHint');
        const tSize = getTargetHandSize();
        if (state.phase === 'INIT') { indicator.innerText = `ğŸŸ¡ èµ·æ‰‹é…ç‰Œ (${state.hand.length}/${tSize})`; hint.innerText = "ç‚¹å‡»ä¸‹æ–¹ç‰Œåº“é€‰æ‹©èµ·æ‰‹ç‰Œ..."; }
        else if (state.phase === 'DRAW') { indicator.innerText = `ğŸŸ¢ ç­‰å¾…æ‘¸ç‰Œ (å½“å‰${tSize}å¼ )`; hint.innerText = "è½®åˆ°ä½ æ‘¸ç‰Œäº†..."; }
        else if (state.phase === 'DISCARD') { indicator.innerText = `ğŸ”´ å†³ç­–ä¸­ (å½“å‰${tSize+1}å¼ )`; hint.innerText = "æ ¹æ®å»ºè®®ï¼Œç‚¹å‡»ä½ è¦æ‰“å‡ºçš„æ‰‹ç‰Œ..."; }
        UNICODE_TILES.forEach((char, id) => {
            const btn = document.getElementById(`palette-btn-${id}`);
            if (btn) {
                if (getTileCount(id) >= 4) { btn.classList.add('opacity-30', 'cursor-not-allowed', 'bg-gray-200'); btn.classList.remove('hover:border-blue-400', 'hover:bg-blue-50', 'bg-white'); }
                else { btn.classList.remove('opacity-30', 'cursor-not-allowed', 'bg-gray-200'); btn.classList.add('hover:border-blue-400', 'hover:bg-blue-50', 'bg-white'); }
            }
        });
    }

    async function requestAnalysis() {
        try {
            const requireYaku = document.getElementById('requireYaku').checked;
            // æ–°å¢ï¼šè·å–é£ç‰Œçš„å€¼ (å­—ç¬¦ä¸²è½¬æ•°å­—)
            const roundWind = parseInt(document.getElementById('roundWind').value);
            const playerWind = parseInt(document.getElementById('playerWind').value);

            const res = await fetch('/api/evaluate_state', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                // ä¿®æ”¹ï¼šå°† round_wind å’Œ player_wind åŠ å…¥å‘é€å†…å®¹
                body: JSON.stringify({
                    hand: state.hand, dead: state.dead, melds: state.melds, dora: state.dora,
                    require_yaku: requireYaku, round_wind: roundWind, player_wind: playerWind
                })
            });
            const data = await res.json();
            if (res.ok) renderResults(data); else alert("å‡ºé”™: " + data.error);
        } catch (e) { console.error(e); }
    }
    function renderResults(data) {
        document.getElementById('resultArea').classList.remove('hidden');
        document.getElementById('shantenBadge').classList.remove('hidden');
        const badge = document.getElementById('shantenBadge');
        const list = document.getElementById('recommendationsList');
        list.innerHTML = '';

        // 1. é¡¶éƒ¨çŠ¶æ€å¾½ç« ä¸èƒ¡ç‰Œæ‹¦æˆª
        if (data.shanten === -1) {
            badge.innerText = 'ğŸ‰ å·²å’Œç‰Œ';
            badge.className = 'bg-red-100 text-red-800 text-sm font-bold px-3 py-1 rounded ml-2 border border-red-300';
            list.innerHTML = `<div class="p-8 text-center bg-red-50 rounded-xl border-2 border-red-200 shadow-sm mt-2"><div class="text-4xl mb-4">ğŸ†</div><div class="text-2xl font-bold text-red-600">èƒ¡ç‰Œå•¦ï¼</div></div>`;
            return; // èƒ¡ç‰Œåç›´æ¥ä¸­æ­¢ï¼Œä¸æ¸²æŸ“æ‰“ç‰Œå»ºè®®
        } else if (data.shanten === 0) {
            badge.innerText = 'å·²å¬ç‰Œ (è¿›å…¥æ‰“ç‚¹æœŸæœ›æ¨¡å¼)';
            badge.className = 'bg-orange-100 text-orange-800 text-xs font-bold px-2 py-1 rounded ml-2 border border-orange-200';
        } else {
            badge.innerText = data.shanten + ' å‘å¬';
            badge.className = 'bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded ml-2 border border-blue-200';
        }

        // 2. éå†æ¸²æŸ“ AI æ¨èå¡ç‰‡
        data.recommendations.forEach(rec => {
            const card = document.createElement('div');
            // å¡ç‰‡æ ·å¼ï¼šåŠ å…¥é¼ æ ‡æ‚¬æµ®ç‰¹æ•ˆä¸æ‰‹å‹å…‰æ ‡
            card.className = "bg-white rounded shadow border-l-4 border-blue-400 p-3 flex justify-between items-center mb-2 cursor-pointer transition transform hover:-translate-y-1 hover:shadow-md hover:bg-blue-50";

            // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼šè‡ªåŠ¨å»æ‰‹ç‰Œé‡Œæ‰¾è¿™å¼ ç‰Œå¹¶æ‰“å‡ºå»
            card.onclick = () => {
                if (state.phase === 'DISCARD') {
                    const handIndex = state.hand.indexOf(rec.discard_id);
                    if (handIndex !== -1) handleHandClick(handIndex);
                }
            };

            // ç”Ÿæˆè¿›å¼ è¯¦æƒ…ï¼ˆå¸¦é¢œè‰²æ”¯æŒï¼‰
            const detailsHtml = rec.details.map(d => `<span class="text-xs bg-gray-100 border border-gray-200 rounded px-1 flex items-center shadow-sm"><span class="text-lg mr-0.5 ${getTileColorClass(d.id)}">${d.char}</span>${d.name}(å‰©<span class="font-bold text-blue-600 ml-0.5">${d.left}</span>)</span>`).join(' ');

            // ã€æ ¸å¿ƒé€è§†é€»è¾‘ã€‘ï¼šEV æ˜¾ç¤ºä¸åº•å±‚æŠ¥é”™æ‹¦æˆª
            let evHtml = '';
            if (rec.ev !== null && rec.ev !== undefined) {
                if (rec.ev === 0 && rec.err) {
                    // å¦‚æœè¢«åˆ¤ 0 åˆ†ä¸”æœ‰åº•å±‚é”™è¯¯ä¿¡æ¯ï¼Œç›´æ¥äº®å‡ºçº¢ç‰Œ
                    evHtml = `<span class="text-xs font-bold text-red-600 bg-red-100 px-2 py-0.5 rounded ml-2 border border-red-300">ğŸš¨ åˆ¤é›¶åŸå› : ${rec.err}</span>`;
                } else {
                    // æ­£å¸¸ EV æ˜¾ç¤º
                    evHtml = `<span class="text-xs font-bold text-orange-600 bg-orange-100 px-2 py-0.5 rounded ml-2 border border-orange-200">ğŸ”¥ EV: ${Math.round(rec.ev)}</span>`;
                }
            }

            // å¼‚å¸¸å±€é¢é¢„è­¦æ ‡ç­¾ (é€€é¿å‘å¬ / æ­»å¬)
            const retreatHtml = rec.is_retreat ? `<span class="text-xs font-bold text-red-600 bg-red-100 px-2 py-0.5 rounded ml-2 border border-red-200 animate-pulse">âš ï¸ çµæ´»é€€å‘å¬</span>` : '';
            const deadHtml = rec.total_ukeire === 0 ? `<span class="text-xs font-bold text-gray-500 bg-gray-200 px-2 py-0.5 rounded ml-2 border border-gray-300">ğŸ’€ ç»å¯¹æ­»è·¯</span>` : '';

            // æ‹¼è£…æ•´å¼ å¡ç‰‡
            card.innerHTML = `
                <div class="flex items-center w-full">
                    <span class="text-4xl mr-4 ${getTileColorClass(rec.discard_id)}">${rec.discard_char}</span>
                    <div class="flex-1">
                        <div class="font-bold text-sm text-gray-800 flex items-center flex-wrap gap-y-1">
                            æ‰“å‡º ${rec.discard_name}
                            <span class="text-xs text-blue-500 font-normal ml-2 bg-blue-50 px-1 rounded border border-blue-100">è¿›å¼ : ${rec.total_ukeire}</span>
                            ${evHtml}
                            ${retreatHtml}
                            ${deadHtml}
                        </div>
                        <div class="flex flex-wrap gap-1 mt-2">${detailsHtml}</div>
                    </div>
                </div>`;
            list.appendChild(card);
        });
    }

    function resetGame() { if(confirm("é‡æ–°å¼€å±€ï¼Ÿ")) { state = { hand: [], dead: [], melds: [], dora: [], phase: 'INIT', keyboardMode: 'self' }; setKeyboardMode('self'); document.getElementById('resultArea').classList.add('hidden'); document.getElementById('shantenBadge').classList.add('hidden'); updateUI(); } }
    renderPalette(); updateUI();
</script>
</body>
</html>